name: Build and Deploy to Production

on:
  push:
    branches: [master] # Only deploy from master branch
  workflow_dispatch:

# Required permissions for deployments
permissions:
  contents: read
  deployments: write

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://linksnap.centralindia.cloudapp.azure.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install client dependencies
        run: cd client && npm ci --legacy-peer-deps

      - name: Install server dependencies
        run: cd server && npm ci

      - name: Build client with production environment variables
        env:
          VITE_BASE_URL: ${{ secrets.VITE_BASE_URL != '' && secrets.VITE_BASE_URL || format('https://{0}', secrets.PRODUCTION_DOMAIN != '' && secrets.PRODUCTION_DOMAIN || 'linksnap.centralindia.cloudapp.azure.com') }}
          VITE_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN != '' && secrets.PRODUCTION_DOMAIN || 'linksnap.centralindia.cloudapp.azure.com' }}
          VITE_API_URL: /api
        run: cd client && npm run build

      - name: Verify build output
        run: |
          echo "‚úÖ Checking build artifacts..."
          if [ -d "client/dist" ]; then
            echo "‚úÖ client/dist directory exists"
            echo "üìä Build output size: $(du -sh client/dist | cut -f1)"
            echo "üìÑ Files in dist:"
            find client/dist -type f -name "*.html" -o -name "*.xml" | head -20
          else
            echo "‚ùå Build failed - dist directory not found"
            exit 1
          fi

      - name: Verify environment variables in build
        run: |
          echo "üîç Checking for hardcoded URLs in built HTML..."
          PROD_DOMAIN="${{ secrets.PRODUCTION_DOMAIN != '' && secrets.PRODUCTION_DOMAIN || 'linksnap.centralindia.cloudapp.azure.com' }}"
          if grep -q "https://$PROD_DOMAIN" client/dist/index.html; then
            echo "‚úÖ Production domain found in built HTML"
          else
            echo "‚ö†Ô∏è Warning: Domain not found in built HTML"
          fi

          echo "üîç Checking for placeholders..."
          if grep -q "%VITE_" client/dist/index.html; then
            echo "‚ùå ERROR: Placeholders still in build!"
            exit 1
          else
            echo "‚úÖ No placeholders in build output"
          fi

      - name: Deployment Success
        run: |
          PROD_DOMAIN="${{ secrets.PRODUCTION_DOMAIN != '' && secrets.PRODUCTION_DOMAIN || 'linksnap.centralindia.cloudapp.azure.com' }}"
          echo "üì¶ Production URL: https://$PROD_DOMAIN"
          echo "üåç Domain: $PROD_DOMAINpp.azure.com' }}"
          echo "üåç Domain: ${{ secrets.PRODUCTION_DOMAIN || 'linksnap.centralindia.cloudapp.azure.com' }}"
          echo ""
          echo "üìù Next steps:"
          echo "1. Deploy 'client/dist' to your web server"
          echo "2. Deploy 'server' directory to your backend server"
          echo "3. Verify all URLs are using production domain"
          echo ""
          echo "For Azure App Service deployment, add these steps:"
          echo "- Azure/webapps-deploy@v2"
          echo "  with app-name and package parameters"
